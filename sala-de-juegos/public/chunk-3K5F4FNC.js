import{a as d,b as l}from"./chunk-5YNXMIIZ.js";import{C as f,N as u,P as m,V as U,g as o,n as b,o as n,s as g}from"./chunk-TXKU6S6B.js";import{j as a}from"./chunk-4ZZIO3ZI.js";var w=class i{supabase;_user$=new o(null);user$=this._user$.asObservable();_ready$=new o(!1);ready$=this._ready$.asObservable();miUsuario$=this.user$.pipe(m(r=>r?b(this.getMiUsuario()).pipe(f(s=>(console.error("Error al obtener mi usuario:",s?.message||s),n(null)))):n(null)),u(1));esAdmin$=this.miUsuario$.pipe(g(r=>(r?.PERFIL??"").toString().toLowerCase()==="administrador"),u(1));constructor(){this.supabase=d(l.supabase.url,l.supabase.anonKey),this.bootstrap()}bootstrap(){return a(this,null,function*(){let{data:{session:r},error:s}=yield this.supabase.auth.getSession();s&&console.warn("getSession error:",s.message),this._user$.next(r?.user??null),this.supabase.auth.onAuthStateChange((t,e)=>{this._user$.next(e?.user??null),this._ready$.value||this._ready$.next(!0)}),this._ready$.value||this._ready$.next(!0)})}login(r,s){return a(this,null,function*(){let{data:t,error:e}=yield this.supabase.auth.signInWithPassword({email:r,password:s});if(e)throw console.error("Error al intentar loguearse:",e.message),e;return t.user})}register(r,s,t){return a(this,null,function*(){let{data:e,error:p}=yield this.supabase.auth.signUp({email:r,password:s});if(p)throw p;let c=e.user,{error:h}=yield this.supabase.from("USUARIOS").upsert({ID_USUARIO:c.id,EMAIL:r,NOMBRE:t??null,PERFIL:"Usuario"});if(h)throw h;return c})}logout(){return a(this,null,function*(){yield this.supabase.auth.signOut()})}getUsuarioActual(){return a(this,null,function*(){let{data:{user:r}}=yield this.supabase.auth.getUser();return r??null})}getMiUsuario(){return a(this,null,function*(){let r=yield this.getUsuarioActual();if(!r)return null;let{data:s,error:t}=yield this.supabase.from("USUARIOS").select("*").eq("ID_USUARIO",r.id).single();if(t)throw t;return s})}static \u0275fac=function(s){return new(s||i)};static \u0275prov=U({token:i,factory:i.\u0275fac,providedIn:"root"})};export{w as a};
